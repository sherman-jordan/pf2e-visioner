{{!--
  Modern ApplicationV2 template for Visioner Token Manager
  Provides comprehensive interface for managing token visibility and cover relationships
--}}

{{#if error}}
  <div class="notification error">
    <p>{{error}}</p>
  </div>
{{else}}
  <div class="visioner-token-manager">

  {{!-- Icon-only Tab Navigation and Legend moved to top-right inside observer-info --}}

  {{!-- Observer Information with Mode Toggle - Always visible --}}
  <div class="observer-info">
    <div class="observer-image">
      <img src="{{observer.img}}" data-tooltip="{{observer.name}}" />
    </div>
    <div class="observer-content">
      <div class="observer-main">
        <button type="button" class="mode-toggle {{#if isObserverMode}}observer-active{{else}}target-active{{/if}}" data-action="toggleMode" title="Click to switch between Observer and Target modes" {{#if lootObserver}}disabled{{/if}}>
          {{#if lootObserver}}
            <div class="toggle-option active">
              <i class="fas fa-user-secret"></i>
              <span>Target</span>
            </div>
          {{else}}
            <div class="toggle-option {{#if isObserverMode}}active{{/if}}">
              <i class="fas fa-eye"></i>
              <span>Observer</span>
            </div>
            <div class="toggle-divider">|</div>
            <div class="toggle-option {{#if isTargetMode}}active{{/if}}">
              <i class="fas fa-user-secret"></i>
              <span>Target</span>
            </div>
          {{/if}}
        </button>
        <h3 class="observer-name">{{observer.name}}</h3>
        {{#if isCoverTab}}
          {{#if isObserverMode}}
            <p class="hint">How much cover other tokens have against <em>{{observer.name}}</em></p>
          {{else}}
            <p class="hint">How much cover <em>{{observer.name}}</em> has against other tokens</p>
          {{/if}}
        {{else}}
          {{#if isObserverMode}}
            <p class="hint">How <em>{{observer.name}}</em> sees other tokens</p>
          {{else}}
            <p class="hint">How other tokens see <em>{{observer.name}}</em></p>
          {{/if}}
        {{/if}}
        
        {{!-- Encounter Filter + Ignore Allies --}}
        <div class="encounter-filter-section" style="display:flex; gap:16px; align-items:center;">
          {{#if showEncounterFilter}}
          <label class="encounter-filter-checkbox" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" {{#if encounterOnly}}checked{{/if}} data-action="toggleEncounterFilter" />
            <span class="encounter-filter-label">{{localize "PF2E_VISIONER.UI.ENCOUNTER_FILTER_TEXT"}}</span>
          </label>
          {{/if}}
          <label class="ignore-allies-filter-checkbox" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" {{#if ignoreAllies}}checked{{/if}} data-action="toggleIgnoreAllies" />
            <span class="encounter-filter-label">Ignore allies</span>
          </label>
          {{#if isObserverMode}}
            {{#if isVisibilityTab}}
              <label class="ignore-walls-filter-checkbox" style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" {{#if ignoreWalls}}checked{{/if}} data-action="toggleIgnoreWalls" />
                <span class="encounter-filter-label">Ignore walls</span>
              </label>
            {{/if}}
          {{/if}}
        </div>
      </div>
    </div>

    <div class="observer-tools">
      <div class="icon-tab-navigation">
        <button type="button" class="icon-tab-button {{#if isVisibilityTab}}active{{/if}}" data-action="toggleTab" data-tab="visibility" title="{{localize "PF2E_VISIONER.TOKEN_MANAGER.VISIBILITY_TAB"}}">
          <i class="fas fa-eye"></i>
        </button>
        {{#unless hideCoverTab}}
          <button type="button" class="icon-tab-button {{#if isCoverTab}}active{{/if}}" data-action="toggleTab" data-tab="cover" title="{{localize "PF2E_VISIONER.TOKEN_MANAGER.COVER_TAB"}}">
            <i class="fas fa-shield-alt"></i>
          </button>
        {{/unless}}
      </div>
      <div class="legend-panel">
        {{#if isVisibilityTab}}
          <div class="visibility-legend">
            {{#each visibilityStates as |state|}}
              <div class="legend-item" title="{{state.label}}">
                <i class="{{state.icon}}" style="color: {{state.color}}"></i>
                <span>{{state.label}}</span>
              </div>
            {{/each}}
          </div>
        {{else}}
          <div class="cover-legend">
            {{#each coverStates as |state|}}
              <div class="legend-item" title="{{state.label}}{{#if (gt state.bonusAC 0)}} (+{{state.bonusAC}} AC{{#if (gt state.bonusReflex 0)}}, +{{state.bonusReflex}} Reflex{{/if}}{{#if (gt state.bonusStealth 0)}}, +{{state.bonusStealth}} Stealth{{/if}}){{/if}}">
                <i class="{{state.icon}}" style="color: {{state.color}}"></i>
                <span>{{state.label}}</span>
                {{#if (gt state.bonusAC 0)}}
                  <span class="bonus-badge">+{{state.bonusAC}}</span>
                {{/if}}
              </div>
            {{/each}}
          </div>
        {{/if}}
      </div>
    </div>
  </div>

  {{!-- Tab Content --}}
  <div class="visioner-tab-content">
    {{!-- Visibility Tab --}}
    <div class="tab-panel visibility-section {{#if isVisibilityTab}}active{{/if}}">
      {{!-- Legend moved to top-right observer-tools --}}

      {{!-- Scrollable tables area for visibility --}}
      <div class="tables-content">
        {{#if hasTargets}}
          
          {{!-- Player Characters Table --}}
          {{#if hasPCs}}
            <div class="table-section">
              <div class="table-section-header">
                <div class="header-left">
                  <i class="fas fa-users"></i>
                  <span>Player Characters</span>
                </div>
                <div class="bulk-actions-header">
                  {{#each visibilityStates as |state|}}
                    <button type="button" class="bulk-state-header" data-action="bulkPC{{capitalize state.key}}" data-state="{{state.key}}" data-target-type="pc" title="Set all PCs as {{state.label}}">
                      <i class="{{state.icon}}"></i>
                    </button>
                  {{/each}}
                </div>
              </div>
              <div class="visibility-table-container">
                <table class="visibility-table">
                  {{#if showOutcomeColumn}}
                  <colgroup>
                    <col style="width:10%" />
                    <col style="width:15%" />
                    <col style="width:26%" />
                    <col style="width:18%" />
                    <col style="width:12%" />
                    <col style="width:19%" />
                  </colgroup>
                  {{else}}
                  <colgroup>
                    <col style="width:10%" />
                    <col style="width:20%" />
                    <col style="width:32%" />
                    <col style="width:22%" />
                    <col style="width:16%" />
                  </colgroup>
                  {{/if}}
                  <thead>
                    <tr>
                      <th class="token-image">Token</th>
                      <th class="token-name">Name</th>
                      <th class="visibility-state">{{localize "PF2E_VISIONER.TOKEN_MANAGER.VISIBILITY_STATE"}}</th>
                      <th class="current-state">Current State</th>
                      <th class="dc-column">{{#if isTargetMode}}Perception DC{{else}}Stealth DC{{/if}}</th>
                      {{#if showOutcomeColumn}}
                        <th class="outcome-column">Outcome</th>
                      {{/if}}
                    </tr>
                  </thead>
                  <tbody>
                    {{#each pcTargets as |target|}}
                      <tr class="token-row pc-row" data-token-id="{{target.id}}">
                        <td class="token-image">
                          <img src="{{target.img}}" data-tooltip="{{target.name}}" width="28" height="28" />
                        </td>
                        <td class="token-name">
                          <strong title="{{target.name}}">{{target.name}}</strong>
                        </td>
                        <td class="visibility-state">
                          <div class="icon-selection" data-target="{{target.id}}">
                            {{#each target.visibilityStates as |state|}}
                              <button type="button" class="state-icon {{#if state.selected}}selected{{/if}}" 
                                      data-state="{{state.value}}" data-target="{{target.id}}" 
                                      title="{{state.label}}" style="color: {{state.color}}">
                                <i class="{{state.icon}}"></i>
                              </button>
                            {{/each}}
                            <input type="hidden" name="visibility.{{target.id}}" value="{{target.currentVisibilityState}}" />
                          </div>
                        </td>
                        <td class="current-state">
                          {{#each target.visibilityStates as |state|}}
                            {{#if state.selected}}
                              <span class="state-indicator" style="color: {{state.color}}"
                                    {{#if (eq state.value "hidden")}}title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.HIDDEN_TOOLTIP'}}"{{/if}}
                                    {{#if (eq state.value "concealed")}}title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.CONCEALED_TOOLTIP'}}"{{/if}}
                                    {{#if (eq state.value "undetected")}}title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.UNDETECTED_TOOLTIP'}}"{{/if}}
                                    {{#if (eq state.value "observed")}}title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.VISIBLE_TOOLTIP'}}"{{/if}}>
                                <i class="{{state.icon}}"></i>
                                {{state.label}}
                              </span>
                            {{/if}}
                          {{/each}}
                        </td>
                        <td class="dc-column">
                          {{#if isTargetMode}}
                            <span class="dc-value">{{target.perceptionDC}}</span>
                          {{else}}
                            <span class="dc-value">{{target.stealthDC}}</span>
                          {{/if}}
                        </td>
                        {{#if ../showOutcomeColumn}}
                          <td class="outcome-column">
                            {{#if target.showOutcome}}
                              <span class="dc-outcome {{target.outcomeClass}}" title="{{target.outcomeLabel}}">{{target.outcomeLabel}}</span>
                            {{/if}}
                          </td>
                        {{/if}}
                      </tr>
                    {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          {{/if}}

        

          {{!-- NPCs Table --}}
          {{#if hasNPCs}}
            <div class="table-section">
              <div class="table-section-header">
                <div class="header-left">
                  <i class="fas fa-dragon"></i>
                  <span>NPCs</span>
                </div>
                <div class="bulk-actions-header">
                  {{#each visibilityStates as |state|}}
                    <button type="button" class="bulk-state-header" data-action="bulkNPC{{capitalize state.key}}" data-state="{{state.key}}" data-target-type="npc" title="Set all NPCs as {{state.label}}">
                      <i class="{{state.icon}}"></i>
                    </button>
                  {{/each}}
                </div>
              </div>
              <div class="visibility-table-container">
                <table class="visibility-table">
                  {{#if showOutcomeColumn}}
                  <colgroup>
                    <col style="width:10%" />
                    <col style="width:15%" />
                    <col style="width:26%" />
                    <col style="width:18%" />
                    <col style="width:12%" />
                    <col style="width:19%" />
                  </colgroup>
                  {{else}}
                  <colgroup>
                    <col style="width:10%" />
                    <col style="width:20%" />
                    <col style="width:32%" />
                    <col style="width:22%" />
                    <col style="width:16%" />
                  </colgroup>
                  {{/if}}
                  <thead>
                    <tr>
                      <th class="token-image">Token</th>
                      <th class="token-name">Name</th>
                      <th class="visibility-state">{{localize "PF2E_VISIONER.TOKEN_MANAGER.VISIBILITY_STATE"}}</th>
                      <th class="current-state">Current State</th>
                      <th class="dc-column">{{#if isTargetMode}}Perception DC{{else}}Stealth DC{{/if}}</th>
                      {{#if showOutcomeColumn}}
                        <th class="outcome-column">Outcome</th>
                      {{/if}}
                    </tr>
                  </thead>
                  <tbody>
                    {{#each npcTargets as |target|}}
                      <tr class="token-row npc-row {{target.dispositionClass}}-npc" data-token-id="{{target.id}}">
                        <td class="token-image">
                          <img src="{{target.img}}" data-tooltip="{{target.name}}" width="28" height="28" />
                        </td>
                        <td class="token-name">
                          <strong title="{{target.name}}">{{target.name}}</strong>
                        </td>
                        <td class="visibility-state">
                          <div class="icon-selection" data-target="{{target.id}}">
                            {{#each target.visibilityStates as |state|}}
                              <button type="button" class="state-icon {{#if state.selected}}selected{{/if}}" 
                                      data-state="{{state.value}}" data-target="{{target.id}}" 
                                      title="{{state.label}}" style="color: {{state.color}}">
                                <i class="{{state.icon}}"></i>
                              </button>
                            {{/each}}
                            <input type="hidden" name="visibility.{{target.id}}" value="{{target.currentVisibilityState}}" />
                          </div>
                        </td>
                        <td class="current-state">
                          {{#each target.visibilityStates as |state|}}
                            {{#if state.selected}}
                              <span class="state-indicator" style="color: {{state.color}}"
                                    {{#if (eq state.value "hidden")}}title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.HIDDEN_TOOLTIP'}}"{{/if}}
                                    {{#if (eq state.value "concealed")}}title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.CONCEALED_TOOLTIP'}}"{{/if}}
                                    {{#if (eq state.value "undetected")}}title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.UNDETECTED_TOOLTIP'}}"{{/if}}
                                    {{#if (eq state.value "observed")}}title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.VISIBLE_TOOLTIP'}}"{{/if}}>
                                <i class="{{state.icon}}"></i>
                                {{state.label}}
                              </span>
                            {{/if}}
                          {{/each}}
                        </td>
                        <td class="dc-column">
                          {{#if isTargetMode}}
                            <span class="dc-value">{{target.perceptionDC}}</span>
                          {{else}}
                            <span class="dc-value">{{target.stealthDC}}</span>
                          {{/if}}
                        </td>
                        {{#if ../showOutcomeColumn}}
                          <td class="outcome-column">
                            {{#if target.showOutcome}}
                              <span class="dc-outcome {{target.outcomeClass}}" title="{{target.outcomeLabel}}">{{target.outcomeLabel}}</span>
                            {{/if}}
                          </td>
                        {{/if}}
                      </tr>
                    {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          {{/if}}
          {{!-- Loot Table --}}
        {{#if hasLoots}}
          <div class="table-section loot-section">
            <div class="table-section-header">
              <div class="header-left">
                <i class="fas fa-box"></i>
                <span>Loot</span>
              </div>
              <div class="bulk-actions-header">
                <button type="button" class="bulk-state-header" data-action="bulkLootObserved" data-state="observed" data-target-type="loot" title="Set all Loot as Observed">
                  <i class="fas fa-eye"></i>
                </button>
                <button type="button" class="bulk-state-header" data-action="bulkLootHidden" data-state="hidden" data-target-type="loot" title="Set all Loot as Hidden">
                  <i class="fas fa-eye-slash"></i>
                </button>
              </div>
            </div>
            <div class="visibility-table-container">
              <table class="visibility-table">
                {{#if showOutcomeColumn}}
                <colgroup>
                  <col style="width:10%" />
                  <col style="width:15%" />
                  <col style="width:26%" />
                  <col style="width:18%" />
                  <col style="width:12%" />
                  <col style="width:19%" />
                </colgroup>
                {{else}}
                <colgroup>
                  <col style="width:10%" />
                  <col style="width:20%" />
                  <col style="width:32%" />
                  <col style="width:22%" />
                  <col style="width:16%" />
                </colgroup>
                {{/if}}
                <thead>
                  <tr>
                    <th class="token-image">Token</th>
                    <th class="token-name">Name</th>
                    <th class="visibility-state">{{localize "PF2E_VISIONER.TOKEN_MANAGER.VISIBILITY_STATE"}}</th>
                    <th class="current-state">Current State</th>
                    <th class="dc-column">{{#if isTargetMode}}Perception DC{{else}}Stealth DC{{/if}}</th>
                    {{#if showOutcomeColumn}}
                      <th class="outcome-column">Outcome</th>
                    {{/if}}
                  </tr>
                </thead>
                <tbody>
                  {{#each lootTargets as |target|}}
                    <tr class="token-row npc-row" data-token-id="{{target.id}}">
                      <td class="token-image">
                        <img src="{{target.img}}" data-tooltip="{{target.name}}" width="28" height="28" />
                      </td>
                      <td class="token-name">
                        <strong title="{{target.name}}">{{target.name}}</strong>
                      </td>
                      <td class="visibility-state">
                        <div class="icon-selection" data-target="{{target.id}}">
                          {{#each target.visibilityStates as |state|}}
                            <button type="button" class="state-icon {{#if state.selected}}selected{{/if}}" 
                                    data-state="{{state.value}}" data-target="{{target.id}}" 
                                    title="{{state.label}}" style="color: {{state.color}}">
                              <i class="{{state.icon}}"></i>
                            </button>
                          {{/each}}
                          <input type="hidden" name="visibility.{{target.id}}" value="{{target.currentVisibilityState}}" />
                        </div>
                      </td>
                      <td class="current-state">
                        {{#each target.visibilityStates as |state|}}
                          {{#if state.selected}}
                            <span class="state-indicator" style="color: {{state.color}}">
                              <i class="{{state.icon}}"></i>
                              {{state.label}}
                            </span>
                          {{/if}}
                        {{/each}}
                      </td>
                      <td class="dc-column">
                        {{#if ../isTargetMode}}
                          <span class="dc-value">{{target.perceptionDC}}</span>
                        {{else}}
                          <span class="dc-value">{{target.stealthDC}}</span>
                        {{/if}}
                      </td>
                      {{#if ../showOutcomeColumn}}
                        <td class="outcome-column">
                          {{#if target.showOutcome}}
                            <span class="dc-outcome {{target.outcomeClass}}" title="{{target.outcomeLabel}}">{{target.outcomeLabel}}</span>
                          {{/if}}
                        </td>
                      {{/if}}
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        {{/if}}
          
          {{#if includeWalls}}
              <div class="table-section walls-section">
              <div class="table-section-header">
                <div class="header-left">
                  <i class="fas fa-grip-lines-vertical"></i>
                  <span>Hidden Walls</span>
                </div>
                  <div class="bulk-actions-header">
                    <button type="button" class="bulk-state-header" data-action="bulkWallsObserved" data-state="observed" data-target-type="walls" title="Set all listed walls as Observed">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="bulk-state-header" data-action="bulkWallsHidden" data-state="hidden" data-target-type="walls" title="Set all listed walls as Hidden">
                      <i class="fas fa-eye-slash"></i>
                    </button>
                  </div>
              </div>
              <div class="visibility-table-container">
                <table class="visibility-table">
                  <colgroup>
                    <col style="width:10%" />
                    <col style="width:30%" />
                    <col style="width:20%" />
                    <col style="width:30%" />
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="token-image">Wall</th>
                      <th class="token-name">Identifier</th>
                      <th class="visibility-state">{{localize "PF2E_VISIONER.TOKEN_MANAGER.VISIBILITY_STATE"}}</th>
                      <th class="dc-column">DC</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each wallTargets as |w|}}
                      <tr class="token-row wall-row" data-wall-id="{{w.id}}">
                        <td class="token-image">
                          <img src="{{w.img}}" data-tooltip="{{#if w.isDoor}}Door{{else}}Wall{{/if}}" width="28" height="28" />
                        </td>
                        <td class="token-name">
                          <strong title="{{w.identifier}}">{{w.identifier}}</strong>
                        </td>
                        <td class="visibility-state">
                          <div class="icon-selection" data-target="{{w.id}}">
                            {{#each w.visibilityStates as |state|}}
                              <button type="button" class="state-icon {{#if state.selected}}selected{{/if}}" 
                                      data-state="{{state.value}}" data-target="{{w.id}}" 
                                      title="{{state.label}}" style="color: {{state.color}}">
                                <i class="{{state.icon}}"></i>
                              </button>
                            {{/each}}
                            <input type="hidden" name="walls.{{w.id}}" value="{{w.currentVisibilityState}}" />
                          </div>
                        </td>
                        <td class="dc-column"><span class="dc-value">{{w.dc}}</span></td>
                      </tr>
                    {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          {{/if}}
        {{else}}
          <div class="no-targets">
            <p>{{localize "PF2E_VISIONER.TOKEN_MANAGER.NO_TOKENS"}}</p>
          </div>
        {{/if}}
      </div>
    </div>

    {{!-- Cover Tab --}}
    {{#unless hideCoverTab}}
    <div class="tab-panel cover-section {{#if isCoverTab}}active{{/if}}">
      {{!-- Legend moved to top-right observer-tools --}}

      {{!-- Scrollable tables area for cover --}}
      <div class="tables-content">
        {{#if hasTargets}}
          
          {{!-- Player Characters Table --}}
          {{#if hasPCs}}
            <div class="table-section">
              <div class="table-section-header">
                <div class="header-left">
                  <i class="fas fa-users"></i>
                  <span>Player Characters</span>
                </div>
                <div class="bulk-actions-header">
                  {{#each coverStates as |state|}}
                    {{!-- Special-case mapping for "none" → bulkPCNoCover --}}
                    <button
                      type="button"
                      class="bulk-state-header"
                      data-action="{{#if (eq state.key "none")}}bulkPCNoCover{{else}}bulkPC{{capitalize state.key}}Cover{{/if}}"
                      data-state="{{state.key}}"
                      data-target-type="pc"
                      title="Set all PCs as {{state.label}}">
                      <i class="{{state.icon}}"></i>
                    </button>
                  {{/each}}
                </div>
              </div>
              <div class="cover-table-container">
                <table class="cover-table">
                  <thead>
                    <tr>
                      <th class="token-image">Token</th>
                      <th class="token-name">Name</th>
                      <th class="cover-state">{{localize "PF2E_VISIONER.TOKEN_MANAGER.COVER_STATE"}}</th>
                      <th class="current-state">Current State</th>
                      <th class="mechanical-effects">Effects</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each pcTargets as |target|}}
                      <tr class="token-row pc-row" data-token-id="{{target.id}}">
                        <td class="token-image">
                          <img src="{{target.img}}" data-tooltip="{{target.name}}" width="28" height="28" />
                        </td>
                        <td class="token-name">
                          <strong title="{{target.name}}">{{target.name}}</strong>
                        </td>
                        <td class="cover-state">
                          <div class="icon-selection" data-target="{{target.id}}">
                            {{#each target.coverStates as |state|}}
                              <button type="button" class="state-icon {{#if state.selected}}selected{{/if}}" 
                                      data-state="{{state.value}}" data-target="{{target.id}}" 
                                      title="{{state.label}}" style="color: {{state.color}}">
                                <i class="{{state.icon}}"></i>
                              </button>
                            {{/each}}
                            <input type="hidden" name="cover.{{target.id}}" value="{{target.currentCoverState}}" />
                          </div>
                        </td>
                        <td class="current-state">
                          {{#each target.coverStates as |state|}}
                            {{#if state.selected}}
                              <span class="state-indicator" style="color: {{state.color}}">
                                <i class="{{state.icon}}"></i>
                                {{state.label}}
                              </span>
                            {{/if}}
                          {{/each}}
                        </td>
                        <td class="mechanical-effects">
                          {{#if (eq target.currentCoverState "none")}}
                            <span class="no-effect cover-none" title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.NO_COVER_TOOLTIP'}}">
                              <i class="fas fa-check-circle"></i> No cover
                            </span>
                          {{else if (eq target.currentCoverState "lesser")}}
                            <span class="cover-effect cover-lesser" title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.LESSER_COVER_TOOLTIP'}}">
                              <i class="fas fa-shield-alt"></i> +1 AC
                            </span>
                          {{else if (eq target.currentCoverState "standard")}}
                            <span class="cover-effect cover-standard" title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.STANDARD_COVER_TOOLTIP'}}">
                              <i class="fas fa-shield-alt"></i> +2 AC, +2 Reflex, +2 Stealth
                            </span>
                          {{else if (eq target.currentCoverState "greater")}}
                            <span class="cover-effect cover-greater" title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.GREATER_COVER_TOOLTIP'}}">
                              <i class="fas fa-shield"></i> +4 AC, +4 Reflex, +4 Stealth
                            </span>
                          {{/if}}
                        </td>
                      </tr>
                    {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          {{/if}}

          {{!-- NPCs Table --}}
          {{#if hasNPCs}}
            <div class="table-section">
              <div class="table-section-header">
                <div class="header-left">
                  <i class="fas fa-dragon"></i>
                  <span>NPCs</span>
                </div>
                <div class="bulk-actions-header">
                  {{#each coverStates as |state|}}
                    {{!-- Special-case mapping for "none" → bulkNPCNoCover --}}
                    <button
                      type="button"
                      class="bulk-state-header"
                      data-action="{{#if (eq state.key "none")}}bulkNPCNoCover{{else}}bulkNPC{{capitalize state.key}}Cover{{/if}}"
                      data-state="{{state.key}}"
                      data-target-type="npc"
                      title="Set all NPCs as {{state.label}}">
                      <i class="{{state.icon}}"></i>
                    </button>
                  {{/each}}
                </div>
              </div>
              <div class="cover-table-container">
                <table class="cover-table">
                  <thead>
                    <tr>
                      <th class="token-image">Token</th>
                      <th class="token-name">Name</th>
                      <th class="cover-state">{{localize "PF2E_VISIONER.TOKEN_MANAGER.COVER_STATE"}}</th>
                      <th class="current-state">Current State</th>
                      <th class="mechanical-effects">Effects</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each npcTargets as |target|}}
                      {{#unless target.isLoot}}
                      <tr class="token-row npc-row {{target.dispositionClass}}-npc" data-token-id="{{target.id}}">
                        <td class="token-image">
                          <img src="{{target.img}}" data-tooltip="{{target.name}}" width="28" height="28" />
                        </td>
                        <td class="token-name">
                          <strong title="{{target.name}}">{{target.name}}</strong>
                        </td>
                        <td class="cover-state">
                          <div class="icon-selection" data-target="{{target.id}}">
                            {{#each target.coverStates as |state|}}
                              <button type="button" class="state-icon {{#if state.selected}}selected{{/if}}" 
                                      data-state="{{state.value}}" data-target="{{target.id}}" 
                                      title="{{state.label}}" style="color: {{state.color}}">
                                <i class="{{state.icon}}"></i>
                              </button>
                            {{/each}}
                            <input type="hidden" name="cover.{{target.id}}" value="{{target.currentCoverState}}" />
                          </div>
                        </td>
                        <td class="current-state">
                          {{#each target.coverStates as |state|}}
                            {{#if state.selected}}
                              <span class="state-indicator" style="color: {{state.color}}">
                                <i class="{{state.icon}}"></i>
                                {{state.label}}
                              </span>
                            {{/if}}
                          {{/each}}
                        </td>
                        <td class="mechanical-effects">
                          {{#if (eq target.currentCoverState "none")}}
                            <span class="no-effect cover-none" title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.NO_COVER_TOOLTIP'}}">
                              <i class="fas fa-check-circle"></i> No cover
                            </span>
                          {{else if (eq target.currentCoverState "lesser")}}
                            <span class="cover-effect cover-lesser" title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.LESSER_COVER_TOOLTIP'}}">
                              <i class="fas fa-shield-alt"></i> +1 AC
                            </span>
                          {{else if (eq target.currentCoverState "standard")}}
                            <span class="cover-effect cover-standard" title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.STANDARD_COVER_TOOLTIP'}}">
                              <i class="fas fa-shield-alt"></i> +2 AC, +2 Reflex, +2 Stealth
                            </span>
                          {{else if (eq target.currentCoverState "greater")}}
                            <span class="cover-effect cover-greater" title="{{localize 'PF2E_VISIONER.MECHANICAL_EFFECTS.GREATER_COVER_TOOLTIP'}}">
                              <i class="fas fa-shield"></i> +4 AC, +4 Reflex, +4 Stealth
                            </span>
                          {{/if}}
                        </td>
                      </tr>
                      {{/unless}}
                    {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          {{/if}}
          
        {{else}}
          <div class="no-targets">
            <p>{{localize "PF2E_VISIONER.TOKEN_MANAGER.NO_TOKENS"}}</p>
          </div>
        {{/if}}
      </div>
    </div>
    {{/unless}}
  </div>

  {{!-- Action Buttons --}}
  <footer class="sheet-footer flexrow">
    <button type="button" class="vm-action-button apply" data-action="applyCurrent">
      <i class="fas fa-check"></i>
      {{localize "PF2E_VISIONER.TOKEN_MANAGER.APPLY"}}
    </button>
    <button type="button" class="vm-action-button apply" data-action="applyBoth">
      <i class="fas fa-layer-group"></i>
      {{localize "PF2E_VISIONER.TOKEN_MANAGER.APPLY_BOTH"}}
    </button>
    <button type="button" class="vm-action-button reset" data-action="reset">
      <i class="fas fa-undo"></i>
      {{localize "PF2E_VISIONER.TOKEN_MANAGER.RESET"}}
    </button>
    <button type="button" class="vm-action-button cancel" data-action="close">
      <i class="fas fa-times"></i>
      {{localize "PF2E_VISIONER.TOKEN_MANAGER.CANCEL"}}
    </button>
  </footer>

  </div>

  {{/if}}
